{% extends "layout.html" %}

{% block title %}Categorize Transactions - Firefly Categorizer{% endblock %}

{% block head %}
    <style>
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toggle Switch Styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-6 text-gray-700">Categorize Transactions</h1>

        <!-- Filter Section -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Filter Transactions</h2>
            <form action="/" method="get" class="flex gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium">Start Date</label>
                    <input type="date" name="start_date" class="border p-2 rounded" value="{{ start_date }}">
                </div>
                <div>
                    <label class="block text-sm font-medium">End Date</label>
                    <input type="date" name="end_date" class="border p-2 rounded" value="{{ end_date }}">
                </div>
                <div class="flex flex-col pb-1">
                    <span class="text-sm font-medium text-gray-700 mb-1">Show Categorized</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="show-categorized" onchange="renderTransactions()" 
                            class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="show-categorized" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
                
                <div class="flex flex-col pb-1">
                    <label class="text-sm font-medium text-gray-700 mb-1">Per Page</label>
                    <select id="limit-select" class="border p-1 rounded text-sm bg-white h-[34px]" onchange="changeLimit(this.value)">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                    </select>
                </div>

                <button type="submit"
                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Fetch</button>
                <button type="button" onclick="runCategorization()"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 ml-2">Run Categorization</button>
            </form>
        </div>

        <!-- Transactions List -->
        <div class="bg-white p-4 rounded shadow">
            <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
                Transactions
                <div id="loading-state" class="hidden flex items-center gap-2">
                    <span id="loading-text" class="text-sm text-gray-500 font-normal">Loading...</span>
                    <div class="spinner"></div>
                </div>
            </h2>

            <!-- Top Pagination Controls -->
            <div class="pagination-controls flex justify-center items-center mb-4 border-b pb-4 hidden gap-4">
                 <button class="prev-page-btn px-3 py-1 border rounded bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage(-1)">Previous</button>
                 
                 <div class="text-sm text-gray-600">
                    Page <span class="current-page-display font-bold">1</span> of <span class="total-pages-display font-bold">1</span>
                    (<span class="total-items-display">0</span> transactions)
                 </div>
                 
                 <button class="next-page-btn px-3 py-1 border rounded bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage(1)">Next</button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="bg-gray-100 text-left">
                            <th class="p-2">Date</th>
                            <th class="p-2">Description</th>
                            <th class="p-2">Amount</th>
                            <th class="p-2">Predicted Category</th>
                            <th class="p-2">Confidence</th>
                            <th class="p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                <div id="no-data-message" class="hidden p-4 text-center text-gray-500">
                    No transactions found (or still loading...)
                </div>
            </div>

            <!-- Bottom Pagination Controls -->
            <div class="pagination-controls flex justify-center items-center mt-4 border-t pt-4 hidden gap-4">
                 <button class="prev-page-btn px-3 py-1 border rounded bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage(-1)">Previous</button>
                 
                 <div class="text-sm text-gray-600">
                    Page <span class="current-page-display font-bold">1</span> of <span class="total-pages-display font-bold">1</span>
                    (<span class="total-items-display">0</span> transactions)
                 </div>
                 
                 <button class="next-page-btn px-3 py-1 border rounded bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" onclick="changePage(1)">Next</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <!-- Pass categories to JS -->
    <script>
        // Depending on Jinja config, tojson might be needed or raw list might work if simple strings
        // We use a safe fallback if tojson isn't available by trying to parse the raw python list string representations (single quotes to double)
        // ideally backend passes json string, but let's try to assume safe output
        const CATEGORIES = {{ categories | tojson }}; 
        let currentTransactions = [];
        let currentPage = 1;
        let itemsPerPage = 50;
        let totalPages = 1;
        let totalTransactions = 0;
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchTransactions();
        });

        function runCategorization() {
            fetchTransactions(true);
        }

        async function fetchTransactions(predict = false) {
            const loadingState = document.getElementById('loading-state');
            const loadingText = document.getElementById('loading-text');
            const noData = document.getElementById('no-data-message');
            const tbody = document.getElementById('transactions-body');
            const paginationControls = document.querySelectorAll('.pagination-controls');

            // Set text and show
            loadingText.textContent = predict ? "Categorizing..." : "Fetching...";
            loadingState.classList.remove('hidden');
            
            if (!predict) {
                tbody.innerHTML = '';
            }
            noData.classList.add('hidden');
            paginationControls.forEach(el => el.classList.add('hidden'));

            const params = new URLSearchParams(window.location.search);
            if (predict) {
                params.append('predict', 'true');
            }
            params.append('page', currentPage);
            params.append('limit', itemsPerPage);

            try {
                const response = await fetch(`/api/transactions?${params.toString()}`);
                const data = await response.json();
                
                // Handle new structure
                if (data.transactions) {
                    currentTransactions = data.transactions;
                    if (data.pagination) {
                        totalPages = data.pagination.total_pages || 1;
                        totalTransactions = data.pagination.total || 0;
                    }
                } else {
                    // Fallback for old structure
                    currentTransactions = Array.isArray(data) ? data : [];
                }

                loadingState.classList.add('hidden');
                renderTransactions();

            } catch (error) {
                console.error("Fetch error:", error);
                loadingState.classList.add('hidden');
                noData.textContent = "Error fetching data.";
                noData.classList.remove('hidden');
            }
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                fetchTransactions();
            }
        }
        
        function changeLimit(limit) {
            itemsPerPage = parseInt(limit);
            currentPage = 1; // Reset to page 1
            fetchTransactions();
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactions-body');
            const noData = document.getElementById('no-data-message');
            const paginationControls = document.querySelectorAll('.pagination-controls');
            
            tbody.innerHTML = '';

            if (!currentTransactions || currentTransactions.length === 0) {
                noData.textContent = "No transactions found.";
                noData.classList.remove('hidden');
                paginationControls.forEach(el => el.classList.add('hidden'));
                return;
            }
            noData.classList.add('hidden');
            paginationControls.forEach(el => el.classList.remove('hidden'));

            // Update Pagination UI (All blocks)
            document.querySelectorAll('.current-page-display').forEach(el => el.textContent = currentPage);
            document.querySelectorAll('.total-pages-display').forEach(el => el.textContent = totalPages);
            document.querySelectorAll('.total-items-display').forEach(el => el.textContent = totalTransactions);
            document.querySelectorAll('.prev-page-btn').forEach(btn => btn.disabled = currentPage <= 1);
            document.querySelectorAll('.next-page-btn').forEach(btn => btn.disabled = currentPage >= totalPages);

            // Get toggle state
            const showCategorized = document.getElementById('show-categorized').checked;

            currentTransactions.forEach(t => {
                // Check if already categorized
                const isCategorized = t.existing_category ? true : false;

                // Filter based on toggle
                if (isCategorized && !showCategorized) {
                    return;
                }

                const row = document.createElement('tr');
                row.className = isCategorized ? 'border-b bg-gray-100 text-gray-500' : 'border-b hover:bg-gray-50';

                // Prediction logic
                let predictionName = 'Unknown';
                let confidence = '-';
                let predictedCat = null;

                if (t.prediction) {
                    predictionName = t.prediction.category.name;
                    predictedCat = t.prediction.category.name;
                    confidence = t.prediction.confidence.toFixed(2);
                }

                // Build Options
                let optionsHtml = `<option value="" disabled ${!predictedCat ? 'selected' : ''}>Select Category</option>`;
                CATEGORIES.forEach(cat => {
                    // If already categorized, we might want to pre-select it or just show it disabled
                    // But usually we just want to show the existing category name in the cell and disable controls
                    const isSelected = (cat === predictedCat) ? 'selected' : '';
                    optionsHtml += `<option value="${cat}" ${isSelected}>${cat}</option>`;
                });

                // Inputs logic
                const selectDisabled = isCategorized ? 'disabled' : '';
                const buttonDisabled = isCategorized ? 'disabled' : '';
                const buttonClass = isCategorized
                    ? 'bg-gray-400 text-white px-2 py-1 rounded text-xs ml-2 cursor-not-allowed'
                    : 'bg-indigo-600 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-indigo-700';

                // Display Category Column
                // If categorized, show existing. Else show prediction.
                let categoryDisplay = '';
                if (isCategorized) {
                    const autoLabel = t.auto_approved ? '<span class="text-xs text-green-600 ml-1">(Auto)</span>' : '<span class="text-xs text-gray-400">(Existing)</span>';
                    categoryDisplay = `<span class="font-semibold">${t.existing_category}</span> ${autoLabel}`;
                } else if (predictedCat) {
                    // Source indicator mapping
                    const sourceLabels = {
                        'memory_exact': 'M',
                        'memory_fuzzy': 'M~',
                        'tfidf': 'ML',
                        'llm': 'AI'
                    };
                    const sourceLabel = sourceLabels[t.prediction.source] || t.prediction.source;
                    categoryDisplay = `<span class="font-bold text-indigo-600">${predictionName}</span> <span class="text-xs text-gray-400 ml-1" title="${t.prediction.source}">[${sourceLabel}]</span>`;
                } else {
                    categoryDisplay = `<span class="text-gray-400">Unknown</span>`;
                }

                row.innerHTML = `
                    <td class="p-2">${t.date_formatted}</td>
                    <td class="p-2">${t.description}</td>
                    <td class="p-2">${t.amount} ${t.currency}</td>
                    <td class="p-2">${categoryDisplay}</td>
                    <td class="p-2">${isCategorized ? '-' : confidence}</td>
                    <td class="p-2 flex items-center">
                        <select id="cat-${t.id}" class="border rounded p-1 text-sm bg-white max-w-[150px]" ${selectDisabled}>
                            ${optionsHtml}
                        </select>
                        <button id="btn-${t.id}" onclick="saveTransaction('${t.id}', '${predictedCat || ''}')"
                            class="${buttonClass}" ${buttonDisabled}>Save</button>
                        <!-- Store raw object strictly as a string in a data attribute or hidden div -->
                             <input type="hidden" id="raw-${t.id}" value='${t.raw_obj}'>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function saveTransaction(transactionId, suggestedCategory) {
            const selectEl = document.getElementById(`cat-${transactionId}`);
            // If the element doesn't exist (e.g., deleted), stop
            if (!selectEl) return;

            const categoryName = selectEl.value;
            const btn = document.getElementById(`btn-${transactionId}`);

            if (!categoryName) {
                alert("Please select a category first.");
                return;
            }

            // Inline spinner style - smaller version
            const spinnerHtml = `<div class="inline-block animate-spin h-4 w-4 border-2 border-indigo-500 rounded-full border-t-transparent"></div>`;

            // Disable controls and show spinner
            btn.disabled = true;
            selectEl.disabled = true;
            btn.innerHTML = spinnerHtml;
            btn.className = "px-2 py-1 rounded text-xs ml-2 border border-gray-300 bg-gray-100"; // neutral look

            const rawInput = document.getElementById(`raw-${transactionId}`);
            // raw-id value is the JSON string
            const transactionObj = JSON.parse(rawInput.value);

            try {
                const response = await fetch('/learn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transaction: transactionObj,
                        category: { name: categoryName },
                        transaction_id: transactionId,
                        suggested_category: suggestedCategory || null
                    })
                });

                if (response.ok) {
                    const row = selectEl.closest('tr');

                    // Parse response to check firefly update status if needed, 
                    // but user just wants "positive response" confirmation
                    const resData = await response.json();

                    // Update UI to "Categorized" state
                    row.className = 'border-b bg-gray-100 text-gray-500';

                    // Update Category Column
                    // Find the category cell (4th column, index 3)
                    const catCell = row.cells[3];
                    catCell.innerHTML = `<span class="font-semibold">${categoryName}</span> (Saved)`;

                    // Update Confidence Column
                    const confCell = row.cells[4];
                    confCell.innerHTML = '-';

                    // Update Actions Column
                    // Disable select and button permanently
                    btn.remove(); // Remove button or hide it
                    selectEl.disabled = true;

                    // Optional: remove spinner if we kept the button, but we removed it.
                    console.log("Learned and updated!");
                } else {
                    // Revert state on failure
                    alert("Failed to update.");
                    btn.disabled = false;
                    selectEl.disabled = false;
                    btn.innerHTML = "Save";
                    btn.className = "bg-indigo-600 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-indigo-700";
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred.");
                // Revert state
                btn.disabled = false;
                selectEl.disabled = false;
                btn.innerHTML = "Save";
                btn.className = "bg-indigo-600 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-indigo-700";
            }
        }
    </script>
{% endblock %}
