<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firefly Categorizer</title>
    <!-- Use simple CSS or Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-indigo-600">Firefly Categorizer</h1>

        <!-- Filter Section -->
        <div class="bg-white p-4 rounded shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">Filter Transactions</h2>
            <form action="/" method="get" class="flex gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium">Start Date</label>
                    <input type="date" name="start_date" class="border p-2 rounded" value="{{ start_date }}">
                </div>
                <div>
                    <label class="block text-sm font-medium">End Date</label>
                    <input type="date" name="end_date" class="border p-2 rounded" value="{{ end_date }}">
                </div>
                <button type="submit"
                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Filter</button>
            </form>
        </div>

        <!-- Transactions List -->
        <div class="bg-white p-4 rounded shadow">
            <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">
                Uncategorized Transactions
                <div id="loading-spinner" class="spinner" style="display: none;"></div>
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="bg-gray-100 text-left">
                            <th class="p-2">Date</th>
                            <th class="p-2">Description</th>
                            <th class="p-2">Amount</th>
                            <th class="p-2">Predicted Category</th>
                            <th class="p-2">Confidence</th>
                            <th class="p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                <div id="no-data-message" class="hidden p-4 text-center text-gray-500">
                    No transactions found (or still loading...)
                </div>
            </div>
        </div>
    </div>

    <!-- Pass categories to JS -->
    <script>
        // Depending on Jinja config, tojson might be needed or raw list might work if simple strings
        // We use a safe fallback if tojson isn't available by trying to parse the raw python list string representations (single quotes to double)
        // ideally backend passes json string, but let's try to assume safe output
        const CATEGORIES = {{ categories | tojson }}; 
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchTransactions();
        });

        async function fetchTransactions() {
            const spinner = document.getElementById('loading-spinner');
            const tbody = document.getElementById('transactions-body');
            const noData = document.getElementById('no-data-message');

            spinner.style.display = 'block';
            tbody.innerHTML = '';
            noData.classList.add('hidden');

            const params = new URLSearchParams(window.location.search);

            try {
                const response = await fetch(`/api/transactions?${params.toString()}`);
                const transactions = await response.json();

                spinner.style.display = 'none';

                if (!transactions || transactions.length === 0) {
                    noData.textContent = "No transactions found.";
                    noData.classList.remove('hidden');
                    return;
                }

                transactions.forEach(t => {
                    const row = document.createElement('tr');

                    // Check if already categorized
                    const isCategorized = t.existing_category ? true : false;

                    row.className = isCategorized ? 'border-b bg-gray-100 text-gray-500' : 'border-b hover:bg-gray-50';

                    // Prediction logic
                    let predictionName = 'Unknown';
                    let confidence = '-';
                    let predictedCat = null;

                    if (t.prediction) {
                        predictionName = t.prediction.category.name;
                        predictedCat = t.prediction.category.name;
                        confidence = t.prediction.confidence.toFixed(2);
                    }

                    // Build Options
                    let optionsHtml = `<option value="" disabled ${!predictedCat ? 'selected' : ''}>Select Category</option>`;
                    CATEGORIES.forEach(cat => {
                        // If already categorized, we might want to pre-select it or just show it disabled
                        // But usually we just want to show the existing category name in the cell and disable controls
                        const isSelected = (cat === predictedCat) ? 'selected' : '';
                        optionsHtml += `<option value="${cat}" ${isSelected}>${cat}</option>`;
                    });

                    // Inputs logic
                    const selectDisabled = isCategorized ? 'disabled' : '';
                    const buttonDisabled = isCategorized ? 'disabled' : '';
                    const buttonClass = isCategorized
                        ? 'bg-gray-400 text-white px-2 py-1 rounded text-xs ml-2 cursor-not-allowed'
                        : 'bg-indigo-600 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-indigo-700';

                    // Display Category Column
                    // If categorized, show existing. Else show prediction.
                    let categoryDisplay = '';
                    if (isCategorized) {
                        const autoLabel = t.auto_approved ? '<span class="text-xs text-green-600 ml-1">(Auto)</span>' : '<span class="text-xs text-gray-400">(Existing)</span>';
                        categoryDisplay = `<span class="font-semibold">${t.existing_category}</span> ${autoLabel}`;
                    } else if (predictedCat) {
                        // Source indicator mapping
                        const sourceLabels = {
                            'memory_exact': 'M',
                            'memory_fuzzy': 'M~',
                            'tfidf': 'ML',
                            'llm': 'AI'
                        };
                        const sourceLabel = sourceLabels[t.prediction.source] || t.prediction.source;
                        categoryDisplay = `<span class="font-bold text-indigo-600">${predictionName}</span> <span class="text-xs text-gray-400 ml-1" title="${t.prediction.source}">[${sourceLabel}]</span>`;
                    } else {
                        categoryDisplay = `<span class="text-gray-400">Unknown</span>`;
                    }

                    row.innerHTML = `
                        <td class="p-2">${t.date_formatted}</td>
                        <td class="p-2">${t.description}</td>
                        <td class="p-2">${t.amount} ${t.currency}</td>
                        <td class="p-2">${categoryDisplay}</td>
                        <td class="p-2">${isCategorized ? '-' : confidence}</td>
                        <td class="p-2 flex items-center">
                            <select id="cat-${t.id}" class="border rounded p-1 text-sm bg-white max-w-[150px]" ${selectDisabled}>
                                ${optionsHtml}
                            </select>
                            <button id="btn-${t.id}" onclick="saveTransaction('${t.id}', '${predictedCat || ''}')"
                                class="${buttonClass}" ${buttonDisabled}>Save</button>
                            <!-- Store raw object strictly as a string in a data attribute or hidden div -->
                             <input type="hidden" id="raw-${t.id}" value='${t.raw_obj}'>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("Fetch error:", error);
                spinner.style.display = 'none';
                noData.textContent = "Error fetching data.";
                noData.classList.remove('hidden');
            }
        }

        async function saveTransaction(transactionId, suggestedCategory) {
            const selectEl = document.getElementById(`cat-${transactionId}`);
            // If the element doesn't exist (e.g., deleted), stop
            if (!selectEl) return;

            const categoryName = selectEl.value;
            const btn = document.getElementById(`btn-${transactionId}`);

            if (!categoryName) {
                alert("Please select a category first.");
                return;
            }

            // Inline spinner style - smaller version
            const spinnerHtml = `<div class="inline-block animate-spin h-4 w-4 border-2 border-indigo-500 rounded-full border-t-transparent"></div>`;

            // Disable controls and show spinner
            btn.disabled = true;
            selectEl.disabled = true;
            btn.innerHTML = spinnerHtml;
            btn.className = "px-2 py-1 rounded text-xs ml-2 border border-gray-300 bg-gray-100"; // neutral look

            const rawInput = document.getElementById(`raw-${transactionId}`);
            // raw-id value is the JSON string
            const transactionObj = JSON.parse(rawInput.value);

            try {
                const response = await fetch('/learn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transaction: transactionObj,
                        category: { name: categoryName },
                        transaction_id: transactionId,
                        suggested_category: suggestedCategory || null
                    })
                });

                if (response.ok) {
                    const row = selectEl.closest('tr');

                    // Parse response to check firefly update status if needed, 
                    // but user just wants "positive response" confirmation
                    const resData = await response.json();

                    // Update UI to "Categorized" state
                    row.className = 'border-b bg-gray-100 text-gray-500';

                    // Update Category Column
                    // Find the category cell (4th column, index 3)
                    const catCell = row.cells[3];
                    catCell.innerHTML = `<span class="font-semibold">${categoryName}</span> (Saved)`;

                    // Update Confidence Column
                    const confCell = row.cells[4];
                    confCell.innerHTML = '-';

                    // Update Actions Column
                    // Disable select and button permanently
                    btn.remove(); // Remove button or hide it
                    selectEl.disabled = true;

                    // Optional: remove spinner if we kept the button, but we removed it.
                    console.log("Learned and updated!");
                } else {
                    // Revert state on failure
                    alert("Failed to update.");
                    btn.disabled = false;
                    selectEl.disabled = false;
                    btn.innerHTML = "Save";
                    btn.className = "bg-indigo-600 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-indigo-700";
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred.");
                // Revert state
                btn.disabled = false;
                selectEl.disabled = false;
                btn.innerHTML = "Save";
                btn.className = "bg-indigo-600 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-indigo-700";
            }
        }
    </script>
</body>

</html>