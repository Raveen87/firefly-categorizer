{% extends "layout.html" %}

{% block title %}Train Models - Firefly Categorizer{% endblock %}

{% block head %}
    <style>
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }

        .stage-pending {
            opacity: 0.5;
        }

        .stage-active {
            opacity: 1;
        }

        .stage-complete {
            opacity: 1;
        }

        .training-info-panel {
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 55%, #eef2ff 100%);
            box-shadow: 0 18px 40px -32px rgba(15, 23, 42, 0.65);
            overflow: hidden;
            position: relative;
        }

        .training-info-panel::before {
            content: "";
            display: block;
            height: 4px;
            background: linear-gradient(90deg, #4f46e5, #0ea5e9);
        }

        .training-info-summary {
            list-style: none;
            cursor: pointer;
            padding: 18px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            background: linear-gradient(90deg, rgba(79, 70, 229, 0.12), rgba(14, 165, 233, 0.08));
            border-bottom: 1px solid transparent;
        }

        .training-info-summary::-webkit-details-marker {
            display: none;
        }

        .training-info-summary:focus-visible {
            outline: 2px solid #6366f1;
            outline-offset: -2px;
            border-radius: 14px;
        }

        .training-info-summary::after {
            content: "";
            width: 10px;
            height: 10px;
            border-right: 2px solid #4338ca;
            border-bottom: 2px solid #4338ca;
            transform: rotate(45deg);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .training-info-panel[open] .training-info-summary {
            border-bottom-color: #e2e8f0;
            background: linear-gradient(90deg, rgba(79, 70, 229, 0.18), rgba(14, 165, 233, 0.1));
        }

        .training-info-panel[open] .training-info-summary::after {
            transform: rotate(-135deg);
        }

        .info-summary-text {
            display: grid;
            gap: 2px;
        }

        .info-summary-eyebrow {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: #6366f1;
            font-weight: 600;
        }

        .info-summary-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: #1f2937;
            font-family: "Palatino Linotype", "Book Antiqua", Palatino, "Times New Roman", serif;
            letter-spacing: 0.02em;
        }

        .info-summary-subtitle {
            font-size: 0.9rem;
            color: #64748b;
        }

        .training-info-body {
            padding: 18px 20px 20px;
        }

        .training-info-panel[open] .training-info-body {
            animation: info-reveal 0.35s ease;
        }

        @keyframes info-reveal {
            from {
                opacity: 0;
                transform: translateY(-6px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .training-progress-panel {
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            background: linear-gradient(150deg, #ffffff 0%, #f8fafc 50%, #eef2ff 100%);
            box-shadow: 0 22px 50px -40px rgba(15, 23, 42, 0.7);
            overflow: hidden;
            position: relative;
        }

        .training-progress-panel::before {
            content: "";
            display: block;
            height: 6px;
            background: linear-gradient(90deg, #4f46e5, #38bdf8, #22d3ee);
        }

        .training-progress-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 22px 24px 12px;
        }

        .progress-header-text {
            display: grid;
            gap: 4px;
        }

        .progress-eyebrow {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: #6366f1;
            font-weight: 600;
        }

        .progress-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            font-family: "Palatino Linotype", "Book Antiqua", Palatino, "Times New Roman", serif;
            letter-spacing: 0.02em;
        }

        .progress-subtitle {
            font-size: 0.92rem;
            color: #64748b;
        }

        .progress-chip {
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(79, 70, 229, 0.12);
            color: #4338ca;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .progress-chip-success {
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
        }

        .training-progress-body {
            padding: 0 24px 24px;
            display: grid;
            gap: 18px;
        }

        .progress-stage-stack {
            display: grid;
            gap: 18px;
        }

        .progress-stage-card {
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            background: #ffffff;
            box-shadow: 0 14px 40px -35px rgba(15, 23, 42, 0.7);
        }

        .progress-stage-active {
            border-color: #c7d2fe;
            background: linear-gradient(180deg, #ffffff 0%, #eef2ff 100%);
        }

        .progress-stage-success {
            border-color: #bbf7d0;
            background: linear-gradient(180deg, #ffffff 0%, #ecfdf3 100%);
        }

        .progress-stage-error {
            border-color: #fecaca;
            background: linear-gradient(180deg, #ffffff 0%, #fef2f2 100%);
        }

        .progress-stage-paused {
            border-color: #fde68a;
            background: linear-gradient(180deg, #ffffff 0%, #fffbeb 100%);
        }

        .progress-stats {
            font-size: 0.82rem;
            color: #475569;
            background: rgba(79, 70, 229, 0.08);
            padding: 4px 12px;
            border-radius: 999px;
        }

        .progress-track {
            background: #e2e8f0;
            border-radius: 999px;
            height: 10px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4f46e5, #22d3ee);
            box-shadow: 0 0 12px rgba(34, 211, 238, 0.45);
            height: 10px;
        }

        .progress-stat {
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            background: #ffffff;
        }

        .progress-stat-label {
            color: #64748b;
        }

        .progress-stat-value {
            font-weight: 700;
        }

        .progress-stat-indigo {
            border-color: #c7d2fe;
            background: #eef2ff;
        }

        .progress-stat-indigo .progress-stat-value {
            color: #4338ca;
        }

        .progress-stat-neutral {
            border-color: #e2e8f0;
            background: #f8fafc;
        }

        .progress-stat-neutral .progress-stat-value {
            color: #475569;
        }

        .progress-stat-amber {
            border-color: #fde68a;
            background: #fffbeb;
        }

        .progress-stat-amber .progress-stat-value {
            color: #b45309;
        }

        .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .status-icon-success {
            background: #dcfce7;
            color: #15803d;
        }

        .status-icon-error {
            background: #fee2e2;
            color: #b91c1c;
        }

        .status-icon-paused {
            background: #fef3c7;
            color: #b45309;
        }

        .status-title {
            font-weight: 700;
            color: #1f2937;
        }

        .result-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .result-card {
            border-radius: 12px;
            border: 1px solid transparent;
            padding: 12px;
            text-align: center;
            background: #ffffff;
        }

        .result-card-trained {
            border-color: #c7d2fe;
            background: #eef2ff;
        }

        .result-card-skipped {
            border-color: #e2e8f0;
            background: #f8fafc;
        }

        .result-card-total {
            border-color: #bae6fd;
            background: #f0f9ff;
        }

        .result-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #0f172a;
        }

        .result-card-trained .result-value {
            color: #4338ca;
        }

        .result-card-skipped .result-value {
            color: #475569;
        }

        .result-card-total .result-value {
            color: #0284c7;
        }

        .result-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 4px;
        }

        .training-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            padding: 16px;
            border-radius: 16px;
            border: 1px dashed #cbd5f5;
            background: rgba(255, 255, 255, 0.75);
        }

        .training-action {
            border: 1px solid transparent;
            box-shadow: 0 12px 24px -18px rgba(15, 23, 42, 0.7);
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }

        .training-action:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 16px 32px -20px rgba(15, 23, 42, 0.7);
        }

        .training-action-primary {
            background: linear-gradient(135deg, #4f46e5, #0ea5e9);
            color: #ffffff;
            border-color: rgba(79, 70, 229, 0.4);
        }

        .training-action-primary:hover:not(:disabled) {
            filter: brightness(1.05);
        }

        .training-action-warning {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-color: rgba(251, 191, 36, 0.5);
        }

        .training-action-danger {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #b91c1c;
            border-color: rgba(239, 68, 68, 0.4);
        }

        .training-action:disabled {
            box-shadow: none;
            filter: grayscale(0.2);
        }

        .training-menu {
            border-radius: 14px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 20px 36px -28px rgba(15, 23, 42, 0.7);
            background: #ffffff;
            overflow: hidden;
        }

        .training-menu button {
            font-weight: 600;
        }

        .training-warning {
            padding: 14px 16px;
            border-radius: 14px;
            border: 1px solid #fecaca;
            background: linear-gradient(120deg, #fff1f2 0%, #fef2f2 100%);
            color: #9f1239;
            font-size: 0.86rem;
        }

        .training-warning p {
            margin: 0;
        }

        .training-page-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--ink);
            letter-spacing: 0.01em;
        }

        .training-info-panel {
            border: 1px solid var(--line);
            background: var(--panel);
            box-shadow: var(--shadow);
        }

        .training-info-panel::before {
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-alt));
        }

        .training-info-summary {
            background: rgba(31, 157, 176, 0.1);
        }

        .training-info-summary:focus-visible {
            outline: 2px solid rgba(31, 157, 176, 0.5);
            outline-offset: -2px;
        }

        .training-info-summary::after {
            border-right-color: var(--accent-strong);
            border-bottom-color: var(--accent-strong);
        }

        .info-summary-eyebrow {
            color: var(--accent-strong);
            font-family: var(--font-mono);
        }

        .info-summary-title {
            color: var(--ink);
            font-family: var(--font-sans);
        }

        .info-summary-subtitle {
            color: var(--muted);
        }

        .training-progress-panel {
            border: 1px solid var(--line);
            background: var(--panel);
            box-shadow: var(--shadow);
        }

        .training-progress-panel::before {
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-alt));
        }

        .progress-eyebrow {
            color: var(--accent-strong);
            font-family: var(--font-mono);
        }

        .progress-title {
            color: var(--ink);
            font-family: var(--font-sans);
        }

        .progress-subtitle {
            color: var(--muted);
        }

        .progress-chip {
            background: rgba(31, 157, 176, 0.12);
            color: var(--accent-strong);
            font-family: var(--font-mono);
        }

        .progress-chip-success {
            background: rgba(34, 197, 94, 0.16);
            color: #15803d;
        }

        .progress-stage-card {
            border: 1px solid var(--line);
            background: var(--panel-strong);
            box-shadow: var(--shadow-soft);
        }

        .progress-stage-active {
            border-color: rgba(31, 157, 176, 0.4);
            background: rgba(31, 157, 176, 0.08);
        }

        .progress-stage-success {
            border-color: rgba(34, 197, 94, 0.4);
            background: rgba(34, 197, 94, 0.08);
        }

        .progress-stage-error {
            border-color: rgba(239, 68, 68, 0.4);
            background: rgba(239, 68, 68, 0.08);
        }

        .progress-stage-paused {
            border-color: rgba(245, 158, 11, 0.4);
            background: rgba(245, 158, 11, 0.08);
        }

        .progress-stats {
            background: rgba(15, 23, 42, 0.06);
            color: var(--ink-soft);
            font-family: var(--font-mono);
        }

        .progress-track {
            background: var(--panel-soft);
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--accent), var(--accent-alt));
            box-shadow: 0 0 12px rgba(31, 157, 176, 0.35);
        }

        .progress-stat {
            border-color: var(--line);
            background: var(--panel-strong);
        }

        .progress-stat-label {
            color: var(--muted);
            font-family: var(--font-mono);
        }

        .progress-stat-value {
            font-family: var(--font-mono);
        }

        .progress-stat-indigo {
            border-color: rgba(37, 99, 235, 0.3);
            background: rgba(37, 99, 235, 0.08);
        }

        .progress-stat-indigo .progress-stat-value {
            color: #1d4ed8;
        }

        .progress-stat-neutral {
            border-color: var(--line);
            background: var(--panel-soft);
        }

        .progress-stat-neutral .progress-stat-value {
            color: var(--ink-soft);
        }

        .progress-stat-amber {
            border-color: rgba(245, 158, 11, 0.35);
            background: rgba(245, 158, 11, 0.1);
        }

        .progress-stat-amber .progress-stat-value {
            color: #b45309;
        }

        .status-icon {
            font-family: var(--font-mono);
        }

        .status-icon-success {
            background: rgba(34, 197, 94, 0.16);
            color: #15803d;
        }

        .status-icon-error {
            background: rgba(239, 68, 68, 0.16);
            color: #b91c1c;
        }

        .status-icon-paused {
            background: rgba(245, 158, 11, 0.18);
            color: #b45309;
        }

        .result-card {
            background: var(--panel-strong);
        }

        .result-card-trained {
            border-color: rgba(37, 99, 235, 0.3);
            background: rgba(37, 99, 235, 0.08);
        }

        .result-card-skipped {
            border-color: var(--line);
            background: var(--panel-soft);
        }

        .result-card-total {
            border-color: rgba(31, 157, 176, 0.3);
            background: rgba(31, 157, 176, 0.08);
        }

        .result-value {
            font-family: var(--font-mono);
        }

        .training-actions {
            border: 1px dashed rgba(31, 157, 176, 0.25);
            background: rgba(255, 255, 255, 0.75);
        }

        .training-action {
            box-shadow: var(--shadow-soft);
        }

        .training-action-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #ffffff;
            border-color: rgba(31, 157, 176, 0.5);
        }

        #train-menu-btn.training-action-primary {
            background: linear-gradient(135deg, var(--accent-strong), var(--accent));
            border-left-color: rgba(255, 255, 255, 0.35);
        }

        .training-action-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(249, 115, 22, 0.3));
            color: #92400e;
            border-color: rgba(245, 158, 11, 0.5);
        }

        .training-action-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(248, 113, 113, 0.3));
            color: #991b1b;
            border-color: rgba(239, 68, 68, 0.5);
        }

        .training-menu {
            border: none;
            box-shadow: none;
            background: transparent;
            padding: 6px;
        }

        .training-menu-item {
            width: 100%;
            text-align: left;
            border-radius: 14px;
        }

        .training-menu-item:hover {
            filter: brightness(1.05);
        }

        .training-warning {
            border-color: rgba(239, 68, 68, 0.35);
            background: rgba(239, 68, 68, 0.08);
            color: #7f1d1d;
        }

        .warning-icon {
            background: rgba(239, 68, 68, 0.18);
            color: #b91c1c;
        }

        :root[data-theme="dark"] .training-warning {
            border-color: rgba(248, 113, 113, 0.45);
            background: rgba(248, 113, 113, 0.18);
            color: #fecaca;
        }

        :root[data-theme="dark"] .warning-icon {
            background: rgba(248, 113, 113, 0.28);
            color: #fee2e2;
        }

        :root[data-theme="dark"] .training-action-primary.opacity-50 {
            opacity: 0.9;
        }

        :root[data-theme="dark"] .training-action-primary {
            color: #0b1120;
        }

        :root[data-theme="dark"] .training-action-primary svg {
            color: inherit;
        }

        :root[data-theme="dark"] #train-menu-btn.training-action-primary {
            border-left-color: rgba(2, 6, 23, 0.45);
        }

        .info-block {
            --info-accent: var(--accent);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            background: var(--panel-strong);
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .info-block::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--info-accent);
            border-radius: 16px 0 0 16px;
        }

        .info-block-accent {
            --info-accent: var(--accent);
        }

        .info-block-warn {
            --info-accent: var(--accent-warn);
        }

        .info-block-title {
            font-weight: 700;
            color: var(--ink);
        }

        .webhook-panel {
            border: 1px solid var(--line);
            border-radius: 18px;
            background: var(--panel);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        .webhook-panel::before {
            content: "";
            display: block;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-alt));
        }

        .webhook-header {
            padding: 18px 20px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .webhook-eyebrow {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--accent-strong);
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .webhook-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--ink);
            font-family: var(--font-sans);
        }

        .webhook-subtitle {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 4px;
        }

        .webhook-chip {
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(31, 157, 176, 0.14);
            color: var(--accent-strong);
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            font-family: var(--font-mono);
        }

        .webhook-body {
            padding: 0 20px 20px;
            display: grid;
            gap: 10px;
        }

        .webhook-url-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .webhook-url {
            flex: 1;
            min-width: 240px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: var(--panel-soft);
            padding: 10px 12px;
            font-size: 0.85rem;
            color: var(--ink);
            font-family: var(--font-mono);
        }

        .webhook-copy {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(31, 157, 176, 0.4);
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #ffffff;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: var(--shadow-soft);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .webhook-copy:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 30px -18px rgba(15, 23, 42, 0.55);
        }

        .webhook-copy:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .webhook-status {
            font-size: 0.82rem;
            color: var(--muted);
            min-height: 1.2em;
        }

        .webhook-status-success {
            color: #15803d;
        }

        .webhook-status-error {
            color: #b91c1c;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="page-shell">
        <h1 class="training-page-title mb-6">Train Models</h1>

        <!-- Info Section -->
        <div class="mb-6">
            <details class="training-info-panel">
                <summary class="training-info-summary">
                    <div class="info-summary-text">
                        <span class="info-summary-eyebrow">Training Guide</span>
                        <span class="info-summary-title">What is this?</span>
                        <span class="info-summary-subtitle">How the models learn from your Firefly history.</span>
                    </div>
                </summary>
                <div class="training-info-body">
                    <p class="text-muted mb-4">
                        This feature trains the categorization models using your existing transaction history from Firefly III.
                        It fetches all transactions that already have categories assigned and uses them to teach the
                        <strong>Memory</strong> and <strong>TF-IDF</strong> classifiers.
                    </p>

                    <div class="grid gap-4 lg:grid-cols-2">
                        <div class="info-block info-block-accent">
                            <h3 class="info-block-title text-accent">How it works:</h3>
                            <ul class="list-disc list-inside text-muted mt-2 space-y-1">
                                <li><strong>Memory Matcher:</strong> Stores exact transaction descriptions for instant matching</li>
                                <li><strong>TF-IDF Classifier:</strong> Learns patterns from your categorization history using
                                    machine learning</li>
                            </ul>
                        </div>

                        <div class="info-block info-block-warn">
                            <h3 class="info-block-title text-warn">When to use:</h3>
                            <ul class="list-disc list-inside text-muted mt-2 space-y-1">
                                <li>First time setup - bootstrap models with your existing data</li>
                                <li>After manually categorizing many transactions in Firefly</li>
                                <li>After restoring from a backup or migrating to a new instance</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <section class="webhook-panel mb-6">
            <div class="webhook-header">
                <div>
                    <div class="webhook-eyebrow">Realtime</div>
                    <h2 class="webhook-title">Firefly Webhook</h2>
                    <p class="webhook-subtitle">
                        Point Firefly III to this endpoint to auto-categorize new transactions.
                    </p>
                </div>
                <span class="webhook-chip">POST</span>
            </div>
            <div class="webhook-body">
                <div class="webhook-url-row">
                    <input id="webhook-url" class="webhook-url" type="text" readonly
                        aria-label="Firefly webhook URL" value="">
                    <button id="webhook-copy-btn" type="button" class="webhook-copy" onclick="copyWebhookUrl()">
                        <svg aria-hidden="true" viewBox="0 0 24 24" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="11" height="11" rx="2"></rect>
                            <rect x="4" y="4" width="11" height="11" rx="2"></rect>
                        </svg>
                        Copy URL
                    </button>
                </div>
                <div id="webhook-copy-status" class="webhook-status" role="status" aria-live="polite"></div>
            </div>
        </section>

        <!-- Training Controls -->
        <div class="training-progress-panel">
            <div class="training-progress-header">
                <div class="progress-header-text">
                    <span class="progress-eyebrow">Model Console</span>
                    <h2 class="progress-title">Training Progress</h2>
                    <p class="progress-subtitle">Live run stats and controls for the categorizer.</p>
                </div>
                <div class="progress-chip">Status Console</div>
            </div>

            <div class="training-progress-body">
                <!-- All Stages Container - shown when training starts -->
                <div id="stages-container" class="hidden progress-stage-stack">

                    <!-- Processing Stage -->
                    <div id="stage-processing" class="stage-active progress-stage-card progress-stage-active">
                        <div class="flex items-center justify-between mb-3 flex-wrap gap-3">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-ink">Processing Transactions</span>
                            </div>
                            <span id="process-stats" class="progress-stats">Starting...</span>
                        </div>
                        <div class="w-full progress-track">
                            <div id="process-progress" class="progress-bar progress-fill" style="width: 0%"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mt-3">
                            <div class="progress-stat progress-stat-indigo">
                                <span class="progress-stat-label">Trained</span>
                                <span class="progress-stat-value" id="process-trained">0</span>
                            </div>
                            <div class="progress-stat progress-stat-neutral">
                                <span class="progress-stat-label" title="Non-categorized transactions.">Skipped</span>
                                <span class="progress-stat-value" id="process-skipped">0</span>
                            </div>
                            <div class="progress-stat progress-stat-amber">
                                <span class="progress-stat-label">Avg (last 10)</span>
                                <span class="progress-stat-value" id="process-average">N/A</span>
                            </div>
                        </div>
                    </div>

                    <!-- Complete Stage -->
                    <div id="stage-complete" class="hidden progress-stage-card progress-stage-success">
                        <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
                            <div class="flex items-center gap-2">
                                <span class="status-icon status-icon-success">OK</span>
                                <span class="status-title">Training Complete!</span>
                            </div>
                            <span class="progress-chip progress-chip-success">All stages done</span>
                        </div>
                        <div class="result-grid">
                            <div class="result-card result-card-trained">
                                <div id="result-trained" class="result-value">0</div>
                                <div class="result-label">Trained</div>
                            </div>
                            <div class="result-card result-card-skipped">
                                <div id="result-skipped" class="result-value">0</div>
                                <div class="result-label" title="Non-categorized transactions.">Skipped</div>
                            </div>
                            <div class="result-card result-card-total">
                                <div id="result-total" class="result-value">0</div>
                                <div class="result-label">Total Processed</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error -->
                <div id="stage-error" class="hidden progress-stage-card progress-stage-error">
                    <div class="flex items-start gap-3">
                        <span class="status-icon status-icon-error">!</span>
                        <div>
                            <div class="status-title text-danger">Error</div>
                            <div id="error-message" class="text-danger text-sm mt-1"></div>
                        </div>
                    </div>
                </div>

                <div id="stage-paused" class="hidden progress-stage-card progress-stage-paused">
                    <div class="flex items-start gap-3">
                        <span class="status-icon status-icon-paused">||</span>
                        <div>
                            <div class="status-title text-amber-700">Training paused.</div>
                            <div id="paused-message" class="text-amber-600 text-sm mt-1"></div>
                        </div>
                    </div>
                </div>

                <!-- Start Button -->
                <div class="training-actions">
                    <div id="train-menu-wrapper" class="relative inline-flex">
                        <button id="train-btn" onclick="startTraining()"
                            class="training-action training-action-primary px-6 py-3 rounded-l-lg font-medium flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                    clip-rule="evenodd" />
                            </svg>
                            Resume Training
                        </button>
                        <button id="train-menu-btn" type="button" onclick="toggleTrainMenu()" aria-haspopup="true"
                            aria-expanded="false"
                            class="training-action training-action-primary px-3 py-3 rounded-r-lg font-medium border-l">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="train-menu"
                            class="training-menu hidden absolute right-0 top-full mt-2 w-60 z-10">
                            <button type="button" onclick="startTraining(true)"
                                class="training-action training-action-primary training-menu-item px-6 py-3 font-medium">
                                Start fresh import
                            </button>
                        </div>
                    </div>
                    <button id="pause-btn" onclick="pauseTraining()"
                        class="training-action training-action-warning px-6 py-3 rounded-lg font-medium flex items-center gap-2 opacity-50 cursor-not-allowed"
                        disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                            fill="currentColor">
                            <rect x="5" y="5" width="10" height="10" rx="1.5"></rect>
                        </svg>
                        Pause Training
                    </button>
                    <button id="clear-btn" onclick="clearModels()"
                        class="training-action training-action-danger px-6 py-3 rounded-lg font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                clip-rule="evenodd" />
                        </svg>
                        Clear Models
                    </button>
                </div>

                <div class="training-warning">
                    <p class="font-bold flex items-center gap-2">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full warning-icon">
                            <svg aria-hidden="true" viewBox="0 0 24 24" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 7v6"></path>
                                <circle cx="12" cy="17" r="1.5"></circle>
                                <circle cx="12" cy="12" r="9"></circle>
                            </svg>
                        </span>
                        Warning:
                    </p>
                    <p>Clearing models will delete all learned patterns. Future matching performance will be significantly worse until you retrain. Only do this if your models are polluted with bad data or for testing purposes.</p>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
    <script>
        let trainingEventSource = null;
        let trainingStatusPoll = null;

        function setTrainingButtonsLoading() {
            const btn = document.getElementById('train-btn');
            const menuBtn = document.getElementById('train-menu-btn');
            if (!btn) {
                return;
            }
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            if (menuBtn) {
                menuBtn.disabled = true;
                menuBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            btn.innerHTML = `
                <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Training...
            `;
        }

        function stopTrainingStatusPoll() {
            if (trainingStatusPoll) {
                clearInterval(trainingStatusPoll);
                trainingStatusPoll = null;
            }
        }

        function startTrainingStatusPoll() {
            if (trainingStatusPoll) {
                return;
            }
            trainingStatusPoll = setInterval(async () => {
                const status = await fetchTrainingStatus();
                if (!status) {
                    return;
                }
                applyTrainingStatus(status);
                if (!status.active) {
                    stopTrainingStatusPoll();
                }
            }, 2000);
        }

        async function fetchTrainingStatus() {
            try {
                const response = await fetch('/train-status', { method: 'GET' });
                if (!response.ok) {
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('Training status error:', error);
                return null;
            }
        }

        function updateProcessingUI(data) {
            const fetched = Number.isFinite(data.fetched)
                ? data.fetched
                : (Number.isFinite(data.total_fetched) ? data.total_fetched : 0);
            const total = Number.isFinite(data.total)
                ? data.total
                : (Number.isFinite(data.total_fetched) ? data.total_fetched : 0);
            const percent = Number.isFinite(data.percent)
                ? data.percent
                : (total > 0 ? Math.round((fetched / total) * 1000) / 10 : 0);
            const avgSeconds = Number.isFinite(data.avg_last_10_seconds) ? data.avg_last_10_seconds : 0;
            const remaining = total - fetched;
            const etaText = remaining > 0 && avgSeconds
                ? formatDuration(remaining * avgSeconds)
                : 'N/A';
            const statsText = total
                ? `${fetched} / ${total} processed (${percent}%) | ETA: ${etaText}`
                : `${fetched} processed`;

            document.getElementById('process-stats').textContent = statsText;
            document.getElementById('process-progress').style.width = `${percent}%`;
            document.getElementById('process-trained').textContent = data.trained ?? 0;
            document.getElementById('process-skipped').textContent = data.skipped ?? 0;
            document.getElementById('process-average').textContent = avgSeconds
                ? formatDuration(avgSeconds)
                : 'N/A';
        }

        function applyTrainingStatus(data) {
            if (!data || !data.stage || data.stage === 'idle') {
                return;
            }

            document.getElementById('stages-container').classList.remove('hidden');
            document.getElementById('stage-error').classList.add('hidden');
            document.getElementById('stage-paused').classList.add('hidden');

            if (data.stage === 'error') {
                document.getElementById('stage-error').classList.remove('hidden');
                document.getElementById('error-message').textContent = data.message || 'Training error.';
                resetButton();
                return;
            }

            if (data.stage === 'complete') {
                document.getElementById('stage-processing').classList.add('hidden');
                document.getElementById('stage-complete').classList.remove('hidden');
                document.getElementById('result-trained').textContent = data.trained ?? 0;
                document.getElementById('result-skipped').textContent = data.skipped ?? 0;
                document.getElementById('result-total').textContent = data.total_fetched ?? data.fetched ?? 0;
                document.getElementById('process-progress').style.width = '100%';
                resetButton();
                return;
            }

            document.getElementById('stage-processing').classList.remove('hidden');
            document.getElementById('stage-complete').classList.add('hidden');

            if (data.stage === 'start') {
                document.getElementById('process-stats').textContent = 'Initializing...';
                document.getElementById('process-progress').style.width = '0%';
                document.getElementById('process-trained').textContent = '0';
                document.getElementById('process-skipped').textContent = '0';
                document.getElementById('process-average').textContent = 'N/A';
            } else {
                updateProcessingUI(data);
            }

            if (data.stage === 'paused') {
                const pausedMessage = document.getElementById('paused-message');
                const totalEstimate = data.total || data.total_fetched || data.fetched || 0;
                const summary = totalEstimate
                    ? `Paused after ${data.total_fetched ?? data.fetched ?? 0} of ${totalEstimate} processed.`
                    : `Paused after ${data.total_fetched ?? data.fetched ?? 0} processed.`;
                if (pausedMessage) {
                    pausedMessage.textContent = summary;
                }
                document.getElementById('stage-paused').classList.remove('hidden');
                resetButton();
                return;
            }

            if (data.active) {
                setTrainingButtonsLoading();
                setPauseButtonState('active');
            } else {
                resetButton();
            }
        }

        function closeTrainMenu() {
            const menu = document.getElementById('train-menu');
            const btn = document.getElementById('train-menu-btn');
            if (!menu || !btn) {
                return;
            }
            menu.classList.add('hidden');
            btn.setAttribute('aria-expanded', 'false');
        }

        function toggleTrainMenu() {
            const menu = document.getElementById('train-menu');
            const btn = document.getElementById('train-menu-btn');
            if (!menu || !btn || btn.disabled) {
                return;
            }
            const isHidden = menu.classList.contains('hidden');
            if (isHidden) {
                menu.classList.remove('hidden');
                btn.setAttribute('aria-expanded', 'true');
            } else {
                closeTrainMenu();
            }
        }

        document.addEventListener('click', (event) => {
            const wrapper = document.getElementById('train-menu-wrapper');
            if (!wrapper || wrapper.contains(event.target)) {
                return;
            }
            closeTrainMenu();
        });

        async function clearModels() {
            if (!confirm("⚠️ DANGER: Are you sure you want to clear all models?\n\nThis will permanently delete all learned transaction patterns. Future categorizations will be inaccurate until you retrain the models.\n\nOnly proceed if you are testing or need to reset corrupted data.")) {
                return;
            }
            
            const btn = document.getElementById('clear-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.textContent = "Clearing...";
            
            try {
                const response = await fetch('/clear-models', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    alert('Models cleared successfully!');
                } else {
                    alert('Error clearing models');
                }
            } catch (e) {
                alert('Error: ' + e);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function setStageActive(stageId) {
            const stage = document.getElementById(stageId);
            stage.classList.remove('stage-pending');
            stage.classList.add('stage-active');
        }

        function setStageComplete(stageId, icon) {
            const stage = document.getElementById(stageId);
            stage.classList.remove('stage-pending', 'stage-active');
            stage.classList.add('stage-complete');
            document.getElementById(stageId.replace('stage-', '') + '-icon').textContent = icon || '✅';
        }

        function formatDuration(seconds) {
            if (!Number.isFinite(seconds) || seconds <= 0) {
                return '0s';
            }
            if (seconds < 1) {
                const ms = Math.max(0, Math.round(seconds * 1000));
                return `${ms}ms`;
            }
            const totalSeconds = Math.round(seconds);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const secs = totalSeconds % 60;
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            }
            if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            }
            return `${secs}s`;
        }

        function setPauseButtonState(state) {
            const pauseBtn = document.getElementById('pause-btn');
            if (!pauseBtn) {
                return;
            }
            if (state === 'active') {
                pauseBtn.disabled = false;
                pauseBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                pauseBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <rect x="5" y="5" width="10" height="10" rx="1.5"></rect>
                    </svg>
                    Pause Training
                `;
                return;
            }
            if (state === 'pausing') {
                pauseBtn.disabled = true;
                pauseBtn.classList.add('opacity-50', 'cursor-not-allowed');
                pauseBtn.textContent = 'Pausing...';
                return;
            }
            pauseBtn.disabled = true;
            pauseBtn.classList.add('opacity-50', 'cursor-not-allowed');
            pauseBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <rect x="5" y="5" width="10" height="10" rx="1.5"></rect>
                </svg>
                Pause Training
            `;
        }

        async function pauseTraining() {
            if (!trainingEventSource) {
                return;
            }
            setPauseButtonState('pausing');
            try {
                await fetch('/train-pause', { method: 'POST' });
            } catch (error) {
                console.error('Pause training error:', error);
            }
        }

        async function startTraining(startFresh = false) {
            closeTrainMenu();
            stopTrainingStatusPoll();
            if (trainingEventSource) {
                trainingEventSource.close();
                trainingEventSource = null;
            }

            if (startFresh) {
                const confirmReset = confirm(
                    'Start fresh import?\n\nThis clears all learned models and resets training progress tracking. Transactions will be retrained from scratch.'
                );
                if (!confirmReset) {
                    return;
                }
                try {
                    const response = await fetch('/clear-models', { method: 'POST' });
                    if (!response.ok) {
                        const data = await response.json().catch(() => ({}));
                        const detail = data.message || data.detail || 'Unable to clear models.';
                        alert(detail);
                        return;
                    }
                } catch (error) {
                    console.error('Clear models error:', error);
                    alert('Unable to clear models.');
                    return;
                }
            }

            setTrainingButtonsLoading();

            // Show stages container and reset states
            document.getElementById('stages-container').classList.remove('hidden');
            document.getElementById('stage-complete').classList.add('hidden');
            document.getElementById('stage-error').classList.add('hidden');
            document.getElementById('stage-paused').classList.add('hidden');
            document.getElementById('stage-processing').classList.remove('hidden');
            setPauseButtonState('active');
            
            // Reset stats
            document.getElementById('process-progress').style.width = '0%';
            document.getElementById('process-stats').textContent = 'Starting...';
            document.getElementById('process-trained').textContent = '0';
            document.getElementById('process-skipped').textContent = '0';
            document.getElementById('process-average').textContent = 'N/A';

            // Connect to SSE endpoint
            const eventSource = new EventSource('/train-stream');
            trainingEventSource = eventSource;

            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.stage === 'start') {
                    document.getElementById('process-stats').textContent = 'Initializing...';
                }
                else if (data.stage === 'processing') {
                    const remaining = (data.total || 0) - (data.fetched || 0);
                    const avgSeconds = data.avg_last_10_seconds || 0;
                    const etaText = remaining > 0 && avgSeconds
                        ? formatDuration(remaining * avgSeconds)
                        : 'N/A';
                    document.getElementById('process-stats').textContent =
                        `${data.fetched} / ${data.total} processed (${data.percent}%) | ETA: ${etaText}`;
                    document.getElementById('process-progress').style.width = `${data.percent}%`;
                    document.getElementById('process-trained').textContent = data.trained;
                    document.getElementById('process-skipped').textContent = data.skipped;
                    document.getElementById('process-average').textContent = avgSeconds
                        ? formatDuration(avgSeconds)
                        : 'N/A';
                }
                else if (data.stage === 'complete') {
                    document.getElementById('process-stats').textContent = 'Done';
                    document.getElementById('process-progress').style.width = '100%';
                    document.getElementById('stage-processing').classList.add('hidden');

                    // Show complete section
                    document.getElementById('stage-complete').classList.remove('hidden');
                    document.getElementById('result-trained').textContent = data.trained;
                    document.getElementById('result-skipped').textContent = data.skipped;
                    document.getElementById('result-total').textContent = data.total_fetched;

                    eventSource.close();
                    trainingEventSource = null;
                    resetButton();
                }
                else if (data.stage === 'paused') {
                    const pausedMessage = document.getElementById('paused-message');
                    const totalEstimate = data.total || data.total_fetched || 0;
                    const summary = totalEstimate
                        ? `Paused after ${data.total_fetched} of ${totalEstimate} processed.`
                        : `Paused after ${data.total_fetched} processed.`;
                    if (pausedMessage) {
                        pausedMessage.textContent = summary;
                    }
                    if (typeof data.percent === 'number') {
                        document.getElementById('process-progress').style.width = `${data.percent}%`;
                    }
                    document.getElementById('stage-paused').classList.remove('hidden');

                    eventSource.close();
                    trainingEventSource = null;
                    resetButton();
                }
                else if (data.stage === 'error') {
                    document.getElementById('stage-error').classList.remove('hidden');
                    document.getElementById('error-message').textContent = data.message;

                    eventSource.close();
                    trainingEventSource = null;
                    resetButton();
                }
            };

            eventSource.onerror = function (error) {
                console.error('SSE Error:', error);
                document.getElementById('stage-error').classList.remove('hidden');
                document.getElementById('error-message').textContent = 'Connection lost. Check server logs.';
                eventSource.close();
                trainingEventSource = null;
                resetButton();
            };
        }

        function resetButton() {
            const btn = document.getElementById('train-btn');
            const menuBtn = document.getElementById('train-menu-btn');
            closeTrainMenu();
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                Resume Training
            `;
            if (menuBtn) {
                menuBtn.disabled = false;
                menuBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            setPauseButtonState('idle');
        }

        function buildWebhookUrl() {
            const currentUrl = new URL(window.location.href);
            let basePath = currentUrl.pathname.replace(/\/train\/?$/, "");
            if (basePath.endsWith("/")) {
                basePath = basePath.slice(0, -1);
            }
            currentUrl.pathname = `${basePath}/webhook/firefly`;
            currentUrl.search = "";
            currentUrl.hash = "";
            return currentUrl.toString();
        }

        function setWebhookStatus(message, state) {
            const status = document.getElementById('webhook-copy-status');
            if (!status) {
                return;
            }
            status.textContent = message;
            status.classList.remove('webhook-status-success', 'webhook-status-error');
            if (state === 'success') {
                status.classList.add('webhook-status-success');
            } else if (state === 'error') {
                status.classList.add('webhook-status-error');
            }
        }

        function setWebhookUrl() {
            const input = document.getElementById('webhook-url');
            if (!input) {
                return;
            }
            input.value = buildWebhookUrl();
        }

        async function copyWebhookUrl() {
            const input = document.getElementById('webhook-url');
            if (!input) {
                return;
            }
            const value = input.value.trim();
            if (!value) {
                setWebhookStatus('Unable to determine webhook URL.', 'error');
                return;
            }
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(value);
                } else {
                    input.focus();
                    input.select();
                    document.execCommand('copy');
                    input.setSelectionRange(0, 0);
                }
                setWebhookStatus('Webhook URL copied.', 'success');
            } catch (error) {
                console.error('Webhook copy error:', error);
                setWebhookStatus('Copy failed. Please copy manually.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            setWebhookUrl();
            const status = await fetchTrainingStatus();
            if (!status) {
                return;
            }
            applyTrainingStatus(status);
            if (status.active || status.stage === 'start' || status.stage === 'processing') {
                startTrainingStatusPoll();
            }
        });
    </script>
{% endblock %}
