name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (basic SemVer only: x.y.z, e.g. 1.0.0)"
        required: true
        type: string
      publish_latest:
        description: "Also publish the latest Docker tag"
        required: false
        type: boolean
        default: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      IMAGE_NAME: fifcat/firefly-categorizer
    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Read uv version
        id: uv-version
        shell: bash
        run: |
          version=$(awk -F '"' '/^uv = "/ {print $2}' mise.toml)
          if [ -z "$version" ]; then
            echo "uv version not found in mise.toml" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          version: ${{ steps.uv-version.outputs.version }}
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Install dependencies
        run: uv sync --frozen --all-groups

      - name: Validate version
        shell: bash
        run: |
          if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Version must be basic SemVer (x.y.z) only, e.g. 1.2.3" >&2
            exit 1
          fi
          if git ls-remote --tags origin "v${{ inputs.version }}" | grep -q .; then
            echo "Tag v${{ inputs.version }} already exists" >&2
            exit 1
          fi

      - name: Run tests
        run: uv run pytest

      - name: Type check
        run: uv run ty check

      - name: Lint
        run: uv run ruff check

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        run: |
          uv run python - <<'PY'
          import pathlib
          import re

          version = "${{ inputs.version }}"
          path = pathlib.Path("pyproject.toml")
          text = path.read_text(encoding="utf-8")
          project_header = re.search(r'(?m)^\\[project\\]\\s*$', text)
          if not project_header:
              raise SystemExit("Unable to find [project] section in pyproject.toml")
          section_start = project_header.end()
          next_header = re.search(r'(?m)^\\[.*\\]\\s*$', text[section_start:])
          section_end = section_start + (next_header.start() if next_header else len(text[section_start:]))
          project_section = text[section_start:section_end]
          updated_section, count = re.subn(
              r'(?m)^version = "([^"]+)"\\s*$',
              f'version = "{version}"',
              project_section,
              count=1,
          )
          if count != 1:
              raise SystemExit("Unable to update version in [project] section of pyproject.toml")
          new_text = text[:section_start] + updated_section + text[section_end:]
          path.write_text(new_text, encoding="utf-8")
          PY

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/work:ro" \
            -v "${{ github.workspace }}/CHANGELOG.md:/work/CHANGELOG.md" \
            -w /work ghcr.io/orhun/git-cliff:latest \
            --config cliff.toml --tag "v${{ inputs.version }}" --output CHANGELOG.md
          notes=$(awk '
            BEGIN { in_section = 0 }
            /^## \\[/ {
              if (in_section) exit
              in_section = 1
              next
            }
            { if (in_section) print }
          ' CHANGELOG.md)
          {
            echo "notes<<'EOF'"
            echo "$notes"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ inputs.version }}
            type=raw,value=latest,enable=${{ inputs.publish_latest }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Commit changelog and version
        run: |
          git add pyproject.toml CHANGELOG.md
          git commit -m "chore(release): v${{ inputs.version }}"

      - name: Tag release
        run: |
          git tag "v${{ inputs.version }}"
          git push origin HEAD:main --tags

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: true
